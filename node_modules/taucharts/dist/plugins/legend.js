!function(t,e){if("object"==typeof exports&&"object"==typeof module)module.exports=e(require("taucharts"),require("d3-format"));else if("function"==typeof define&&define.amd)define([,"d3-format"],e);else{var r="object"==typeof exports?e(require("taucharts"),require("d3-format")):e(t.Taucharts,t.d3);for(var n in r)("object"==typeof exports?exports:t)[n]=r[n]}}(window,function(t,e){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var a=e[n]={i:n,l:!1,exports:{}};return t[n].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:n})},r.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=20)}({0:function(e,r){e.exports=t},20:function(t,e,r){"use strict";r.r(e);var n,a,i=r(0),o=r.n(i),c=r(8),l=o.a.api.utils,s=o.a.api.pluginsSDK,u=".tau-chart__legend__reset",d=".tau-chart__legend__item-color",h=".tau-chart__legend__guide--color__overlay",_=4,f=13,g=0,m=function(){return++g},p=o.a.api.utils.xml,v=function(t,e){var r=t[0],n=t[1],a=(n-r)/(e-1),i=l.range(e-2).map(function(t){return r+a*(t+1)});return[r].concat(i).concat(n)},b=function(t,e,r){if(t.length<3)return t.slice(0);if(e<3)return[t[0],t[t.length-1]];var n,a=t[0]<0?Math.abs(t[0]):0,i=function(t){return t},o="sqrt"===r?function(t){return Math.sqrt(t+a)}:i,c="sqrt"===r?function(t){return Math.pow(t,2)-a}:i,s=[(t=t.map(o))[0]],u=t[t.length-1]-t[0],d=.5*u/(e-1),h=l.range(1,e-1).map(function(t){var r=u*t/(e-1);return{min:r-d,mid:r,max:r+d,diff:Number.MAX_VALUE,closest:null}}),_=0,f=function(){if(_!==h.length){var t=n;(n=h[_++]).min=Math.max(n.min,(t&&null!==t.closest?t.closest:s[0])+d)}};return f(),t.forEach(function(t){if(!(t<n.min)){t>n.max&&f();var e=Math.abs(t-n.mid);e<n.diff&&e<d?(n.diff=e,n.closest=t):f(),0===e&&f()}}),h.forEach(function(t){null!==t.closest&&s.push(t.closest)}),s.push(t[t.length-1]),s=s.map(c)},y=function(t){return Math.log(t)/Math.LN10},x=function(t){return 0===t?0:Math.floor(y(Math.abs(t)))},S=(n=/\.0+([^\d].*)?$/,a=/(\.\d+?)0+([^\d].*)?$/,function(t){return t.replace(n,"$1").replace(a,"$1$2")}),w=c.format(".3s"),M=function(t){return S(w(t))},T=function(t,e){var r=Math.max(Math.abs(t),Math.abs(e)),n=x(r),a=t*e>0?Math.abs(e-t):r,i=x(a),o=Math.abs(n-i);return Math.abs(n)>3&&o<=3?M:function(t){var e=x(r-t),n=Math.min((i<0?Math.abs(i):0)+(e<i?1:0),20);return S(t.toFixed(n))}};function L(t){var e=l.defaults(t||{},{formatters:{}}),r=function(t){return null===t||""===t||void 0===t},n=function(t,e){return function(n){var a=n[t],i=JSON.stringify(r(a)?null:a);return e===i}},a=function(t,e,r,n){t.addEventListener(e,function(t){for(var e=t.target;e!==t.currentTarget&&null!==e;)e.matches(r)&&n(t,e),e=e.parentNode})};return{init:function(t){this.instanceId=m(),this._chart=t,this._currentFilters={},this._legendColorByScaleId={},this._legendOrderState={};var r=this._chart.getSpec(),n=function(t){return function(e,n){var a=r.scales[n];return a.type===t&&a.dim&&e.push(n),e}};this._color=Object.keys(r.scales).reduce(n("color"),[]).filter(function(e){return t.getScaleInfo(e).discrete}),this._fill=Object.keys(r.scales).reduce(n("color"),[]).filter(function(e){return!t.getScaleInfo(e).discrete}),this._size=Object.keys(r.scales).reduce(n("size"),[]);var i=this._color.length>0,o=this._fill.length>0,c=this._size.length>0;if(this._assignStaticBrewersOrEx(),i||o||c){switch(e.position){case"left":this._container=this._chart.insertToLeftSidebar(this._containerTemplate);break;case"right":this._container=this._chart.insertToRightSidebar(this._containerTemplate);break;case"top":this._container=this._chart.insertToHeader(this._containerTemplate);break;case"bottom":this._container=this._chart.insertToFooter(this._containerTemplate);break;default:this._container=this._chart.insertToRightSidebar(this._containerTemplate)}i&&(a(this._container,"click",u,function(t,e){this._toggleLegendItem(e,"reset")}.bind(this)),a(this._container,"click",d,function(t,e){var r=t.ctrlKey||t.target.matches(h)?"leave-others":"focus-single";this._toggleLegendItem(e,r)}.bind(this)),a(this._container,"mouseover",d,function(t,e){this._highlightToggle(e,!0)}.bind(this)),a(this._container,"mouseout",d,function(t,e){this._highlightToggle(e,!1)}.bind(this)))}},destroy:function(){var t=this._currentFilters,e=this._chart;Object.keys(t).forEach(function(r){return e.removeFilter(t[r])}),this._container&&this._container.parentElement&&(this._clearPanel(),this._container.parentElement.removeChild(this._container))},onSpecReady:function(t,r){this._formatters=s.getFieldFormatters(r,e.formatters)},_getFormat:function(t){return this._formatters[t]?this._formatters[t].format:function(t){return String(t)}},onRender:function(){this._clearPanel(),this._drawColorLegend(),this._drawFillLegend(),this._drawSizeLegend()},_containerTemplate:'<div class="tau-chart__legend"></div>',_template:l.template(['<div class="tau-chart__legend__wrap">',"<%=top%>",'<div class="tau-chart__legend__title"><%=name%></div>',"<%=items%>","</div>"].join("")),_itemTemplate:l.template(["<div data-scale-id='<%= scaleId %>' data-dim='<%= dim %>' data-value='<%= value %>' class=\"tau-chart__legend__item tau-chart__legend__item-color <%=classDisabled%>\">",'   <div class="tau-chart__legend__guide__wrap">','   <div class="tau-chart__legend__guide tau-chart__legend__guide--color <%=cssClass%>"','        style="background-color: <%=cssColor%>; border-color: <%=borderColor%>;">','       <div class="tau-chart__legend__guide--color__overlay">',"       </div>","   </div>","   </div>",'   <span class="tau-chart__legend__guide__label"><%=label%></span>',"</div>"].join("")),_resetTemplate:l.template(['<div class="tau-chart__legend__reset <%=classDisabled%>">','    <div role="button" class="tau-chart__button">Reset</div>',"</div>"].join("")),_clearPanel:function(){this._container&&(clearTimeout(this._scrollTimeout),this._getScrollContainer().removeEventListener("scroll",this._scrollListener),this._container.innerHTML="")},_drawFillLegend:function(){var t=this;t._fill.forEach(function(e){var r,n,a,i=t._chart.select(function(t){return t.config.color===e})[0];if(i){var o=i.config.guide||{},c=i.getScale("color"),u=c.domain().sort(function(t,e){return t-e}),d=u.reduce(function(t,e){return t&&l.isDate(e)},!0),h=d?u.map(Number):u,_=T(h[0],h[h.length-1]),g=function(){var e=t._chart.getSpec(),r=s.extractFieldsFormatInfo(e)[c.dim].format;return r||(r=function(t){return new Date(t)}),function(t){return String(r(t))}}(),m=d?g:_,b=c.brewer.length,y=((o.color||{}).label||{}).text||c.dim,x=function(t){return t.length*f*.618},S=c.isInteger?(h[1]-h[0])%3==0?4:(h[1]-h[0])%2==0?3:2:3,w=v(h,S),M=(d?w.map(function(t){return new Date(t)}):w).map(m);M[0]===M[M.length-1]&&(M=[M[0]]),t._container.insertAdjacentHTML("beforeend",t._template({name:y,top:null,items:'<div class="tau-chart__legend__gradient-wrapper"></div>'}));var L=t._container.lastElementChild.querySelector(".tau-chart__legend__gradient-wrapper"),C=L.getBoundingClientRect().width,A=!1;M.reduce(function(t,e){return t+x(e)},0)>C&&(M.length>1&&x(M[0])+x(M[M.length-1])>C?A=!0:M=[M[0],M[M.length-1]]);var F=A?(a=-.382*f/2,{width:C,height:120,barX:0,barY:0,barWidth:20,barHeight:120,textAnchor:"start",textX:l.range(S).map(function(){return 25}),textY:1===M.length?60+.618*f:M.map(function(t,e){var r=(M.length-1-e)/(M.length-1);return f*(1-r)+120*r+a})}):(r=x(M[0])/2,n=x(M[M.length-1])/2,{width:C,height:28+f,barX:0,barY:0,barWidth:C,barHeight:20,textAnchor:"middle",textX:1===M.length?[C/2]:M.map(function(t,e){var a=e/(M.length-1);return r*(1-a)+(C-n)*a}),textY:l.range(S).map(function(){return 28+f})}),E=v(h,b).map(function(t,e){return p("stop",{offset:e/(b-1)*100+"%",style:"stop-color:"+c(t)+';stop-opacity:1"'})}),j="legend-gradient-"+t.instanceId,k=p.apply(void 0,["svg",{class:"tau-chart__legend__gradient",width:F.width,height:F.height},p("defs",p.apply(void 0,["linearGradient",{id:j,x1:"0%",y1:A?"100%":"0%",x2:A?"0%":"100%",y2:"0%"}].concat(E))),p("rect",{class:"tau-chart__legend__gradient__bar",x:F.barX,y:F.barY,width:F.barWidth,height:F.barHeight,fill:"url(#"+j+")"})].concat(M.map(function(t,e){return p("text",{x:F.textX[e],y:F.textY[e],"text-anchor":F.textAnchor},t)})));L.insertAdjacentHTML("beforeend",k)}})},_drawSizeLegend:function(){var t=this;t._size.forEach(function(e){var r=t._chart.select(function(t){return t.config.size===e})[0];if(r){var n=r.config.guide||{},a=r.getScale("size"),i=a.domain().sort(function(t,e){return t-e});if(!Array.isArray(i)||!i.every(isFinite))return;var o=((n.size||{}).label||{}).text||a.dim,c=i[0],s=i[i.length-1],u=[c];if(s-c){var d=y(s-c),h=Math.round(4-d),g=Math.pow(10,h),m=l.unique(t._chart.getDataSources({excludeFilter:["legend"]})[a.source].data.map(function(t){return t[a.dim]}).filter(function(t){return t>=c&&t<=s})).sort(function(t,e){return t-e}),v=b(m,_,a.funcType);u=l.unique(v.map(function(t){return Math.round(t*g)/g}))}var x=T(u[0],u[u.length-1]),S=function(t){return t.length*f*.618};u.reverse();var w=u.map(a),M=Math.max.apply(null,w),L=u.map(x);t._container.insertAdjacentHTML("beforeend",t._template({name:o,top:null,items:'<div class="tau-chart__legend__size-wrapper"></div>'}));var C=t._container.lastElementChild.querySelector(".tau-chart__legend__size-wrapper"),A=C.getBoundingClientRect().width,F=!1;(Math.max.apply(null,L.map(S))>A/4||1===L.length)&&(F=!0);var E=F?function(){for(var t,e,r=f,n=w[0]/2,a=w[w.length-1]/2,i=[n],o=1;o<w.length;o++)e=w[o-1]/2,t=w[o]/2,i.push(i[o-1]+Math.max(1.618*f,e+r+t));var c=.618*f/2;return{width:A,height:i[i.length-1]+Math.max(a,f/2),circleX:l.range(w.length).map(function(){return M/2}),circleY:i,textAnchor:"start",textX:l.range(L.length).map(function(){return M+8}),textY:i.map(function(t){return t+c})}}():function(){for(var t,e,r=Math.max(S(L[0])/2,w[0]/2),n=Math.max(S(L[L.length-1])/2,w[w.length-1]/2),a=(A-w.reduce(function(t,e,r){return t+(0===r||r===w.length-1?e/2:e)},0)-r-n)/(_-1),i=[r],o=1;o<w.length;o++)e=w[o-1]/2,t=w[o]/2,i.push(i[o-1]+e+a+t);var c=w.map(function(t){return M-t/2});return{width:A,height:M+8+f,circleX:i,circleY:c,textAnchor:"middle",textX:i,textY:l.range(L.length).map(function(){return M+8+f})}}(),j=p.apply(void 0,["svg",{class:"tau-chart__legend__size",width:E.width,height:E.height}].concat(w.map(function(t,e){return p("circle",{class:"tau-chart__legend__size__item__circle "+(r.config.color?"color-definite":"color-default-size"),cx:E.circleX[e],cy:E.circleY[e],r:t/2})}),L.map(function(t,e){return p("text",{class:"tau-chart__legend__size__item__label",x:E.textX[e],y:E.textY[e],"text-anchor":E.textAnchor},t)})));C.insertAdjacentHTML("beforeend",j)}})},_drawColorLegend:function(){var t=this;t._color.forEach(function(e){var n=t._chart.select(function(t){return t.config.color===e})[0];if(n){var a=n.config.guide||{},i=n.getScale("color"),o=t._chart.getDataSources({excludeFilter:["legend"]}),c=l.unique(o[i.source].data.map(function(t){return t[i.dim]})),s=t._chart.getSpec().scales[e];if(s.order)c=l.union(l.intersection(s.order,c),c);else{var u=t._legendOrderState[e];c=c.sort(function(t,e){var r=u[t]-u[e];return r&&r/Math.abs(r)})}var d=((a.color||{}).label||{}).text||i.dim,h=(a.color||{}).tickFormatNullAlias||"No "+d,_=t._getFormat(i.dim),f=c.map(function(n){var a=JSON.stringify(r(n)?null:n),o=i.dim+a;return{scaleId:e,dim:i.dim,color:i(n),disabled:t._currentFilters.hasOwnProperty(o),label:_(n),value:a}});t._legendColorByScaleId[e]=f,t._container.insertAdjacentHTML("beforeend",t._template({name:d,top:t._resetTemplate({classDisabled:f.some(function(t){return t.disabled})?"":"disabled"}),items:f.map(function(e){return t._itemTemplate({scaleId:e.scaleId,dim:l.escape(e.dim),color:e.color,cssClass:i.toClass(e.color),cssColor:e.disabled?"transparent":i.toColor(e.color),borderColor:i.toColor(e.color),classDisabled:e.disabled?"disabled":"",label:l.escape(r(e.label)?h:e.label),value:l.escape(e.value)})}).join("")}))}}),t._color.length>0&&(t._updateResetButtonPosition(),t._scrollTimeout=null,t._scrollListener=function(){var e=t._container.querySelector(u);e.style.display="none",t._scrollTimeout&&clearTimeout(t._scrollTimeout),t._scrollTimeout=setTimeout(function(){t._updateResetButtonPosition(),e.style.display="",t._scrollTimeout=null},250)},t._getScrollContainer().addEventListener("scroll",t._scrollListener))},_toggleLegendItem:function(t,e){var r=this._currentFilters,a=t?Array.prototype.filter.call(t.parentNode.childNodes,function(t){return t.matches(d)}):null,i=function(t){var e=t.getAttribute("data-dim"),r=t.getAttribute("data-value");return{sid:t.getAttribute("data-scale-id"),dim:e,val:r,key:e+r}},o=function(t){return t in r},c=function(t,e){var a=i(t);if(o(a.key)===e)if(e){var c=r[a.key];delete r[a.key],t.classList.remove("disabled"),this._chart.removeFilter(c)}else{t.classList.add("disabled");var l=n(a.dim,a.val);r[a.key]=this._chart.addFilter({tag:"legend",predicate:function(t){return!l(t)}})}}.bind(this),l=function(e){return e===t},s=!!t&&o(i(t).key),u=function(t,e){t.querySelector(".tau-chart__legend__guide").style.backgroundColor=e?"":"transparent"};if("reset"===e)a.forEach(function(t){c(t,!0),u(t,!0)});else if("leave-others"===e)a.forEach(function(t){l(t)&&c(t,s)}),u(t,s);else if("focus-single"===e){var h=!s&&a.every(function(t){return l(t)||o(i(t).key)});a.forEach(function(t){var e=l(t)||h;c(t,e)}),s&&u(t,!0)}this._chart.refresh()},_highlightToggle:function(t,e){if(!t.matches(".disabled")){var r=t.getAttribute("data-dim"),a=t.getAttribute("data-value"),i=e?n(r,a):function(t){return null};this._chart.select(function(t){return!0}).forEach(function(t){t.fire("highlight",i)})}},_getScrollContainer:function(){return this._container.parentNode.parentNode},_updateResetButtonPosition:function(){this._container.querySelector(u).style.top=this._getScrollContainer().scrollTop+"px"},_generateColorMap:function(t,e){var r=e.length;return t.reduce(function(t,n,a){return t[n]=e[a%r],t},{})},_assignStaticBrewersOrEx:function(){var t=this;t._color.forEach(function(e){var r=t._chart.getSpec().scales[e],n=t._chart.getDataSources({excludeFilter:["legend"]}),a=t._chart.getScaleFactory(n).createScaleInfoByName(e).domain();if(!r.brewer||Array.isArray(r.brewer)){var i=r.brewer||l.range(20).map(function(t){return"color20-"+(1+t)});r.brewer=t._generateColorMap(a,i)}t._legendOrderState[e]=a.reduce(function(t,e,r){return t[e]=r,t},{})})}}}o.a.api.plugins.add("legend",L),e.default=L},8:function(t,r){t.exports=e}})});